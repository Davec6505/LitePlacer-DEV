# LitePlacer Project - Copilot Context

## Project Overview
**LitePlacer** is a pick-and-place machine control application written in C# (.NET Framework 4.8).
Currently supports TinyG and SKR3 (Marlin) firmware. User (Dave) is learning the codebase before
refactoring to support his custom **PIC33MZ GRBL-based CNC firmware**.

## Current Status: LEARNING PHASE
- **Branch:** `master`
- **Phase:** Architecture analysis and understanding
- **Goal:** Full comprehension before creating refactor branch
- **Do NOT refactor yet** - focus on documentation and learning

## User's Custom Firmware
- **Hardware:** PIC33MZ microcontroller
- **Protocol:** GRBL-based with custom extensions
- **Development:** VSCode + MCC (MPLAB Code Configurator) + abstraction layer
- **Location:** Separate repository (kept independent)
- **Baud Rate:** 115200 (TBD - confirm with user)

## Key Architecture Components

### Firmware Communication (Current State)
- **File:** `LitePlacer/CNC.cs` - Main motion control class
- **Pattern:** Synchronous blocking with `Application.DoEvents()`
- **Threading:** UI thread blocks, serial events on background thread
- **Methods ending in `_m`:** Can show MessageBox, block UI thread
- **NO async/await** - uses old-school Thread.Sleep loops

### Camera System
- **Files:** `Camera.cs`, `ImagesForCameras.cs`
- **Status:** Working well - DO NOT TOUCH during refactor
- **Vision algorithms:** Complex, proven - keep as-is

### Coordinate Systems
- **PCB0 (Jig Offset):** Machine coordinates where PCB origin (0,0) is located
  - Stored in: `Setting.General_JigOffsetX/Y`
  - UI Controls: `JigX_textBox`, `JigY_textBox` on Setup Cameras tab
- **Job Offset:** Additional per-job adjustment
  - Stored in: `Setting.Job_Xoffset/Y`
  - UI Controls: `JobOffsetX_textBox`, `JobOffsetY_textBox` on Run Job tab
- **Nozzle Offset:** Camera center to nozzle tip distance
  - Stored in: `Setting.DownCam_NozzleOffsetX/Y`

### Known Issues (From User)
- **10mm X-axis offset:** Was caused by PCB0 being set to 26.20 instead of 16.20
  - Root cause: PCB origin position was incorrect
  - Workaround used: Job Offset X = -10mm (now understood and can be fixed properly)
- **Nozzle calibration unreliable:** Image processing sporadic
  - Issue: Detection at 4 rotation angles (0°, 90°, 180°, 270°) all must succeed
  - Affected by: lighting, zoom factor, focus, size parameters
  - Size parameters scale with zoom: if zoom=3x, multiply size range by 3
  - Better to detect outer circle (nozzle body) than inner circle (bore)
- **Layout issues:** Form doesn't resize properly - tabs/grids stay fixed size
  - Controls lack proper Anchor/Dock settings
  - Not a priority during learning phase

## Planned Refactor (FUTURE - Not Now)

### Target Architecture
1. **Firmware Abstraction:** Interface-based with DI
   - `IFirmwareInterface` - Abstract interface
   - `GrblFirmware` - User's PIC33MZ implementation
   - `TinyGFirmware` - Existing TinyG wrapped
   - `SmoothieFirmware` - Existing Smoothie wrapped

2. **Dependency Injection:** Use Microsoft.Extensions.DependencyInjection
   - Register firmware at startup based on settings
   - Inject into CNCController
   - Testable, swappable implementations

3. **Keep Existing:**
   - Camera system (proven, working)
   - Vision algorithms (complex, stable)
   - Coordinate transform logic (homography works)
   - UI layout (functional, cosmetic issues can wait)

### Migration Strategy
- **Phase 1:** Create feature branch `feature/firmware-di-refactor`
- **Phase 2:** Define interfaces, create GRBL implementation
- **Phase 3:** Test with PIC33MZ hardware
- **Phase 4:** Gradually migrate UI to use new controller
- **Phase 5:** Remove legacy code

## Current Learning Focus
- Tracing CNC command flow from UI ? CNC.cs ? Serial Port
- Understanding position tracking and updates
- Documenting TinyG protocol for comparison with GRBL
- Understanding fiducial-based coordinate transformation
- Understanding nozzle calibration and vision parameters

## Important Conventions
- Methods ending `_m`: Can show dialogs, block UI thread (NOT async/await)
- `DisplayText()`: Logs to UI with color coding
- `Setting.*`: Global settings object (singleton pattern)
- `Cnc.*`: Global CNC controller instance

## Questions Being Answered
1. How does TinyG JSON protocol differ from GRBL plaintext?
2. How are motor settings applied at startup?
3. How does error recovery work?
4. What are the timeout values and why?
5. How does zoom factor affect vision size parameters?

## Code Style Notes
- C# 7.3 language features
- .NET Framework 4.8 (not .NET Core/5+)
- WinForms (not WPF)
- Older patterns: no async/await, uses Application.DoEvents()

## What NOT to Suggest (Yet)
- ? Creating the refactor branch
- ? Adding DI packages
- ? Modernizing to async/await
- ? Fixing UI layout issues
- ? Refactoring existing working code

## What TO Do Now
- ? Answer architecture questions
- ? Explain existing patterns
- ? Help trace code flow
- ? Document discoveries in Plan/ folder
- ? Update this file as understanding grows

## Last Updated
- **Date:** 2026-01-03
- **Status:** Initial setup, learning phase
- **Next:** User studying codebase and using machine

---
*This file is automatically referenced by GitHub Copilot for context.*
